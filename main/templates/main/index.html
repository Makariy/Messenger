<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Messanger</title>
	<link rel="stylesheet" href="{% static 'main/main.css' %}">
</head>
<body>
	<div class="menu">
		<div class="exit">
			<a class="exit__button" href="{% url 'chats_handler' %}?action=exit">
				Exit account
			</a>
			<a class="exit__chat-button" href="{% url 'chats_handler' %}?action=exit_chat">
				Exit chat
			</a>
		</div>
	</div>
	<section class="messanger">
		<div class="container">
			<div class="message-window">
				<div class="messages">
					{% for message in messages %}
					<div class="message" id="{{ message.pk }}">
					  {% if message.type == 'text' %}
					  <h4 class="message__author">{{ message.author.username }}</h4>
					  <p class="message__inner">{{ message.data.text }}</p>
					  {% endif %}
					  {% if message.type == 'image' %}
					  <h4 class="message__author">{{ message.author.username }}</h4>
					  <img src="/file_upload?file_id={{ message.id }}" class="message__inner message__image">
					  {% endif %}
					  <div class="message__actions">
						{% if user == message.author %}
						<button class="message__actions-delete" onclick="deleteMessage({{ message.pk }})">Delete</button>
						{% endif %}
					  </div>
					</div>
					{% endfor %}
				</div>
				<div class="sender">
					<div class="sender__form">
						<input type="text" id="sender__message" placeholder="Enter some message...">
						<button onclick="send()" class="sender__send">
							<img src="{% static 'main/send button.svg' %}">
						</button>
						<input type="file" id="sender__file" placeholder="Image">
					</div>
				</div>
			</div>
		</div>
	</section>
</body>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
</html>

<script>
		var ws = null;
		var command = '';

		function getLastMessage() {
			var messages = document.getElementsByClassName("message");
			if (messages)
				return messages[messages.length-1];
			return null;
		}

		function scrollToLastMessage() {
			var last = getLastMessage();
			if (last)
				last.scrollIntoView();
		}

		$('#sender__message').keyup(function(event) {
			if (event.keyCode == 13) {
   				$('.sender__send').click();
			}
		})

		function connect() {
			ws = new WebSocket('ws://' + window.location.hostname + ':8001');
			ws.onmessage = function(message) {
				if (command == '') {
					command = message.data;
					return;
				}
				if (command == 'send_mes') {
					$('.messages')[0].innerHTML +=  message.data;
					scrollToLastMessage();
				}
				if (command == 'del') {
					document.getElementById(message.data).remove();
				}
				if (command == 'notify_img') {
					document.getElementsByClassName('messages')[0].innerHTML += message.data;
				}
				command = '';
			}
			ws.onopen = function() {
				data = $.get('get_session_id', function(data) { ws.send(document.cookie + '; sessionid=' + data); });
			}
		}

		function sendFile(file) {
			var file = document.getElementById('sender__file').files[0];
			var fd = new FormData();
			fd.append('file', file);
			$.ajax({
				url:'/file_upload',
				type:'post',
				data:fd,
				contentType: false,
				processData: false
			}).done(function(id) {
				ws.send('notify_img');
				ws.send(id);
			});
		}

		function send() {
			var file_input = document.getElementById('sender__file');
			if (!file_input.value == '') {
				sendFile(file_input.files[0]);
			}
			else {
				var input = document.getElementById('sender__message');
				var message = input.value;
				input.value = '';
				ws.send('send_mes');
				ws.send(message);
			}
		}

		function deleteMessage(id) {
			ws.send('del');
			ws.send(id);
		}

		window.onload = scrollToLastMessage;
		connect();
</script>
